{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'fontawesome-free-6.7.2-web/css/all.min.css' %}">
    <script src="{% static 'jquery-jquery-f79d5f1/dist/jquery.min.js' %}"></script>

  
    <link rel="stylesheet" href="{% static 'css/comport_val.css' %}">

    <title>SETTINGS</title>  
</head>
<style>
    /* Highlight style for the clicked button */
.container-1-2 button.active {
    background: linear-gradient(45deg, rgb(0, 3, 14), rgb(255, 137, 3));
    transform: translateY(5px);
}

.focused {
    outline: none;
  border: 2px solid red !important;
  box-shadow: 0 0 5px red;
}



.toggle-btn.focused {
    background: linear-gradient(45deg, rgb(56, 1, 56), rgb(247, 120, 247));
    transform: translateX(3px);
}




.datetime-wrapper {
    display: flex;
    align-items: center;
    gap: 1px;
    border: 1px solid #ccc;
    padding: 5px;
    border-radius: 4px;
    width: 30vw;
    background-color: white;
    font-size: 1vw;
}

.datetime-part {
    width: 2.5em;
    text-align: center;
    font-size: 1rem;
    border: none;
    outline: none;
}

.datetime-part:focus {
    background-color: #eef;
}

.ampm-select {
    width: 4em;
}


.backup-data-wrapper{
    display: flex;
    align-items: center;
    text-align: center;
    gap: 1px;
    border: 2px solid black;
    padding: 5px;
    border-radius: 4px;
    width: 26vw;
    background-color: white;
    font-size: 1vw;
    margin-left: 25%;
}
.backup-data {
    width: 3em;
    text-align: center;
    font-size: 1rem;
    border: none;
    outline: none;
}

.backup-data:focus {
    background-color: #eef;
}



.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-box {
  background-color: white;
  padding: 20px 30px;
  border-radius: 10px;
  text-align: center;
  box-shadow: 0 0 10px #000000aa;
  max-width: 400px;
}

.modal-box button {
  margin-top: 20px;
  padding: 8px 20px;
  font-size: 16px;
}

#notificationOkBtn:focus {
    outline: 2px solid #007bff;
    background-color: #e6f0ff;
    box-shadow: 0 0 5px blue;
}



</style>
<body>
<div class="container-1">
    
    <div class="container-1-1">
        <label>GENERAL SETTINGS</label>
        <button type="button" id="close_btn">
            <i class="fas fa-times" id="close_icon"></i>F12
        </button>
    </div>

    <!-- Custom Notification Modal -->
    <div id="notificationModal" style="display: none;" class="modal-overlay">
        <div class="modal-box">
          <p id="notificationMessage">This is a custom notification.</p>
          <button id="notificationOkBtn">OK</button>
        </div>
      </div>


    <div class="container-1-2">
       

        <button id="comport_btn" onclick="activateButton('comport_btn'); showSubContainer(1)">COMPORT SETTINGS [F1]</button>
        <button id="settings_btn" onclick="activateButton('settings_btn'); showSubContainer(2)">SETTINGS [F2]</button>
        <button id="cmc_btn" onclick="activateButton('cmc_btn'); showSubContainer(3)">CNC SETTINGS [F3]</button>
        <button id="parameter-settings" onclick="activateButton('parameter-settings');">PARAMETER SETTINGS [F6]</button>
        
        
    </div>
</div>


<div class="container-2">
    <div class="container-2-1">
        <div class="sub-container-1 sub-container">
            <div class="left-column">
                <div class="label-select-pair">
                    <label for="comport">COMPORT :</label>
                    <select id="comport" name="comport">
                        {% for port in port_list %}
                            <option value="{{ port }}">{{ port }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="label-select-pair">
                    <label for="baud_rate">BAUD RATE :</label>
                    <select id="baud_rate">
                        <option value="9600">9600</option>
                        <option value="19200" selected>19200</option>
                        
                    </select>
                </div>

                <div class="label-select-pair">
                    <label for="parity">PARITY :</label>
                    <select id="parity">
                        <option value="N" selected>None</option>
                        <option value="E">EVEN</option>
                        <option value="O">ODD</option>
                        <option value="M">MARK</option>
                        <option value="S">SPACE</option>
                    </select>
                </div>

                <div class="label-select-pair">
                    <label for="stop_bit">STOP BIT :</label>
                    <select id="stop_bit">
                        <option value="1">1</option>
                        <option value="1.5">1.5</option>
                        <option value="2">2</option>
                    </select>
                </div>

                <div class="label-select-pair">
                    <label for="data_bit">DATA BIT :</label>
                    <select id="data_bit">
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8" selected>8</option>
                    </select>
                </div>
                <div class="label-select-pair">
                <button  type="submit" id="cancel_btn">CANCEL</button>
                <button type="submit" id="start-button">OK</button>

                <script>
                    document.getElementById("cancel_btn").addEventListener("click", function() {
                        // Redirect to the 'parameter' URL
                        window.location.href = "/measurement/";
                    });
                </script>
            </div>


            </div>
            <div class="right-column">
                <textarea id="output_result"></textarea>
            </div>
        </div>


<!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->
        
        <div class="sub-container-2 sub-container">
            <div class="left_container">
                <button id="operators" class="toggle-btn">OPERATORS</button>
                <button id="shift_settings" class="toggle-btn">SHIFT SETTINGS</button>
                <button id="open_backup" class="toggle-btn">BACKUP</button>
                <button id="parameter_factor" class="toggle-btn">PARAMETER FACTOR</button>
            </div>
            <div class="right_container" style="overflow-y: auto;">
                <table id="table1" class="table hidden">
                    
                    <thead>
                    
                        <tr class="custom-row">
                            <th style="width: 5%;">Sr.No</th>
                            <th id="oper_no">OPERATOR NO</th>
                            <th id="oper_name">OPERATOR NAME</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody-1">
                        {% for operator in operators_value %}
                        <tr class="custom-row">
                            <td>{{ forloop.counter }}</td>  <!-- Display row number -->
                            <td><input type="text" class="no-outline" style="width: 100%;" value="{{ operator.operator_no }}"></td>
                            <td><input type="text" class="no-outline" style="width: 100%;" value="{{ operator.operator_name }}"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: center;" class="button_container">
                                <button onclick="addRow()" id="add_new_btn">ADD NEW</button>
                                <button onclick="saveData()" id="save_btn_cus">SAVE</button>
                                <button id="delete_btn" onclick="deleteRow()">DELETE</button>
                            </td>
                        </tr>
                    </tfoot>
                </table>











            
                <div id="table2" class="table hidden">
                    <center style="color: purple; text-shadow: 2px 2px 4px rgb(240, 118, 240);">
                        <h1><b>SHIFT SETTINGS</b></h1>
                    </center>
                    
                        <div class="form-container">
                            <div class="form-row">
                                <label for="shift" class="form-label">SHIFT</label>
                               
                                <input type="text" id="shift" name="shift" value="SHIFT-" class="form-input focusable">
                            </div>
                            <div class="form-row">
                                <label for="shift_time" class="form-label">START TIME</label>
                                
                                <!-- <input type="text" id="shift_time" name="shift_time"  class="form-input focusable" ><br><br> -->
                                <div id="from_date" class="datetime-wrapper">
                                    
                                    <input type="text" id="hh" maxlength="2" placeholder="HH" class="datetime-part focusable" />
                                    <input type="text" id="min" maxlength="2" placeholder="MM" class="datetime-part focusable" />
                                    <select id="ampm" class="datetime-part ampm-select focusable">
                                        <option value="AM">AM</option>
                                        <option value="PM">PM</option>
                                    </select>

                                </div>
                                
                            
                            
                            
                            </div>
                        </div>
                        
                        
                        <textarea  id="shift_output">
                            {% if shift_settings %}
                                {% for data in shift_settings %}
                                {{ data.shift }} - {{ data.shift_time }}
                                {% endfor %}
                            {% else %}
                                No shift settings available.
                            {% endif %}
                            
                        </textarea>
                    <div class="button_container2">
                    <button type="button" id="cancel-btn" class="focusable"><b>Cancel</b></button>
                    <button type="button" id="save_btn_shift" class="focusable"><b>Save</b></button>  
                    </div>
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
               
                </div>

                <div id="table3" class="table hidden">
                    <center style="color: purple; text-shadow: 2px 2px 4px rgb(240, 118, 240);">
                        <h2><b>BACKUP DATE</b></h2>
                    </center>
                    <div class="custom-border" style="margin-top: 30px;"> 
                        <label for="backup" style="margin-top: 30px;">BACKUPDATE:</label>
                        <!-- <input type="datetime-local" class="backup-data" id="backup_data" name="backup_data" style="width: 200px;"><br><br> -->

                        <div id="backup_data" class="backup-data-wrapper">
                            <input type="text" id="dd" maxlength="2" placeholder="DD" class="backup-data focusable" />
                            /
                            <input type="text" id="mm" maxlength="2" placeholder="MM" class="backup-data focusable" />
                            /
                            
                            <input type="text" id="yyyy" maxlength="4" placeholder="YYYY" class="backup-data focusable" />
                            &nbsp;
                            <input type="text" id="hour" maxlength="2" placeholder="HH" class="backup-data focusable" />
                            :
                            <input type="text" id="minute" maxlength="2" placeholder="MM" class="backup-data focusable" />
                            &nbsp;
                            <select id="ampm_back" class="backup-data ampm-select focusable">
                                <option value="AM">AM</option>
                                <option value="PM">PM</option>
                            </select>
                        </div>
                        
                        <label for="confirm_backup" style="margin-top: 30px;" hidden>Confirm Backup:</label>
                        <input type="checkbox" id="confirm_backup" name="confirm_backup" hidden><br><br>
                        <textarea style="height: 100%; width: 70%; font-weight: bold; font-size: 1vw;" readonly>
                            {% if backup_date %}
                                {{ backup_date.backup_date }}
                            {% else %}
                                No backup_date is available.
                            {% endif %}
                        </textarea>
                    </div><br>
                    <a href="{% url 'measurement' %}">
                        <button type="button" id="cancel-btn" class="focusable"><b>Cancel</b></button>
                    </a>
                    <button type="button" id="save-btn-4" class="focusable"><b>Save</b></button>                  
                </div>

<div id="table4" class="table hidden">
    <center style="color: purple; text-shadow: 2px 2px 4px rgb(240, 118, 240);">
        <h1><b>PARAMETER FACTOR</b></h1>
    </center>

    <div class="form-group">
        <label for="part_model" class="form-label">PART MODEL</label>
        {% if part_model_values %}
            <select id="part_model" name="part_model" class="form-control focusable" required onchange="sendPartModelValue()">
                <option value="" disabled selected>Select a part model</option>
                {% for part_model in part_model_values %}
                    <option value="{{ part_model }}">{{ part_model }}</option>
                {% endfor %}
            </select>
        {% else %}
            <p>No part models available.</p>
        {% endif %}
    </div>

    <div class="form-group">
        <label for="parameter_name" class="form-label">PARAMETER NAME</label>
        <select id="parameter_name" name="parameter_name" class="form-control focusable" required>
        </select>
    </div>

    <div class="form-group">
        <label for="method" class="form-label">METHOD</label>
        <select id="method" name="method" class="form-control focusable" required>
            <option value="+">+</option>
            <option value="-">-</option>
        </select>
    </div>

    <div class="form-group">
        <label for="value" class="form-label">VALUE</label>
        <input type="text" id="value" name="value" class="form-control focusable" required>
    </div>

    <a href="{% url 'measurement' %}">
        <button type="button" id="cancel-btn" class="focusable"><b>Cancel</b></button>
    </a>
    <button type="submit" id="save-btn-5" class="focusable"><b>Save</b></button>
</div>



</div>
</div>


<script>

// Restore active tab on reload
document.addEventListener("DOMContentLoaded", function () {
    const activeTab = localStorage.getItem("activeTab");

    if (activeTab === "settings_btn") {
        activateButton("settings_btn");
        showSubContainer(2);
        localStorage.removeItem("activeTab");
    }
});

// Function to highlight the active button
function activateButton(id) {
    const allButtons = document.querySelectorAll('button');
    allButtons.forEach(btn => btn.classList.remove('active'));

    const target = document.getElementById(id);
    if (target) {
        target.classList.add('active');
    }
}


document.getElementById("cancel-btn").addEventListener("click", function() {
    // Redirect to the 'parameter' URL
    window.location.href = "/measurement/";
});


// Select the button by its ID
document.getElementById("parameter-settings").addEventListener("click", function() {
    // Redirect to the 'parameter' URL
    window.location.href = "/parameter/";
});

        

document.getElementById("close_btn").addEventListener("click", function() {
        // Redirect to the measurement URL
        window.location.href = "{% url 'measurement' %}";
    });











    document.addEventListener('DOMContentLoaded', function () {
        
    const shiftInput = document.getElementById('shift');
    const saveButton = document.getElementById('save_btn_shift');

    // Restrict input to "SHIFT-" followed by 1, 2, or 3 only
    shiftInput.addEventListener('input', function () {
        const validPattern = /^SHIFT-(1|2|3)?$/; // Allow SHIFT-, SHIFT-1, SHIFT-2, SHIFT-3
        if (!validPattern.test(shiftInput.value)) {
            shiftInput.value = 'SHIFT-'; // Reset to the base if invalid
        }
    });

    saveButton.addEventListener('click', function () {
        const shiftValue = shiftInput.value;
        
        // Validate shift input
        if (!/^SHIFT-(1|2|3)$/.test(shiftValue)) {
            showNotifications('Please enter a valid shift value like SHIFT-1, SHIFT-2, or SHIFT-3.');
            return;
        }

        // Get time parts
    const hh = document.getElementById('hh').value.trim();
    const min = document.getElementById('min').value.trim();
    const ampm = document.getElementById('ampm').value;

    // Validate hours and minutes
    const hhNum = parseInt(hh, 10);
    const minNum = parseInt(min, 10);

    if (
        isNaN(hhNum) || hhNum < 1 || hhNum > 12 ||
        isNaN(minNum) || minNum < 0 || minNum > 59 ||
        !(ampm === "AM" || ampm === "PM")
    ) {
        showNotifications("Please enter a valid time in HH:MM AM/PM format.");
        return;
    }

    // Format to HH:MM:00 AM/PM
    const formattedTime = `${hh.padStart(2, '0')}:${min.padStart(2, '0')}:00 ${ampm}`;


        // Data to be sent
        const data = {
            request_type: 'shift_settings',
            shift: shiftValue,
            shift_time: formattedTime,
        };

        console.log('Data to be sent:', data);

        // Send data via AJAX
        $.ajax({
            type: 'POST',
            url: '/comport/',
            data: JSON.stringify(data),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            success: function (response) {
                if (response.status === 'success') {
                    showNotifications('Shift settings saved successfully!');
                  

                    localStorage.setItem("activeTab", "settings_btn");  // save tab state
                window.location.reload();
                } else {
                    showNotifications('Error: ' + response.message);
                }
            },
            error: function (error) {
                console.log('Error:', error);
                showNotifications('An error occurred while saving shift settings.');
            },
        });
    });
});

      


// /////////////////////////////////////////////////////////////////////////////////////////////////

// this is for the backup script


document.getElementById('save-btn-4').addEventListener('click', function () {
    const dd = document.getElementById('dd').value.trim().padStart(2, '0');
    const mm = document.getElementById('mm').value.trim().padStart(2, '0');
    const yyyy = document.getElementById('yyyy').value.trim();
    let hh = document.getElementById('hour').value.trim();
    let min = document.getElementById('minute').value.trim();
    const ampm = document.getElementById('ampm_back').value;

    const confirmBackup = document.getElementById('confirm_backup').checked;

    // Input validation
    if (!dd || !mm || !yyyy || !hh || !min || !ampm) {
        showNotifications('Please fill in all backup date fields before saving.');
        return;
    }

    // Convert to integers
    hh = parseInt(hh, 10);
    min = parseInt(min, 10);

    if (isNaN(hh) || isNaN(min) || hh < 1 || hh > 12 || min < 0 || min > 59) {
        showNotifications('Please enter valid hour (1-12) and minute (0-59).');
        return;
    }

    // Convert 12-hour format to 24-hour
    let hours24 = hh;
    if (ampm === 'PM' && hh !== 12) {
        hours24 += 12;
    } else if (ampm === 'AM' && hh === 12) {
        hours24 = 0;
    }

    const hhStr = hours24.toString().padStart(2, '0');
    const minStr = min.toString().padStart(2, '0');

    // Final format
    const formattedDate = `${dd}-${mm}-${yyyy} ${hhStr}:${minStr}:00 ${ampm}`;
    console.log("Formatted Backup Date:", formattedDate);

    const data = {
        request_type: 'backup_date',
        backup_data: formattedDate,
        confirm_backup: confirmBackup
    };

    sessionStorage.setItem('showOperatorSettings', 'true');

// Send an AJAX POST request
fetch('/comport/', { // Leave the URL empty to use the current endpoint
method: 'POST',
headers: {
    'Content-Type': 'application/json', // JSON content type
    'X-CSRFToken': getCSRFToken() // Include CSRF token for security
},
body: JSON.stringify(data) // Convert data to JSON string
})
.then(response => response.json())
.then(result => {
if (result.status === 'success') {
    showNotifications('Backup settings saved successfully!');
    location.reload(); // Reload the page
} else {
    showNotifications('Failed to save backup settings. Please try again.');
}
})
.catch(error => console.error('Error:', error));
});

// After page loads, check sessionStorage and perform actions
$(document).ready(function() {
// Hide table1 before showing table2
document.getElementById('table2').classList.add('hidden'); // Hide table1 explicitly
document.getElementById('table1').classList.add('hidden'); // Hide table1 explicitly

const showOperatorSettings = sessionStorage.getItem('showOperatorSettings');

if (showOperatorSettings === 'true') {
// Simulate the click of the "OPERATOR SETTINGS" button
document.querySelector('button[onclick="showSubContainer(2)"]').click();

// Make the table3 visible
document.getElementById('table3').classList.remove('hidden');

// Clear the sessionStorage after using it
sessionStorage.removeItem('showOperatorSettings');
} else {
// If showOperatorSettings is not set, ensure table3 is shown on page load
document.getElementById('table1').classList.remove('hidden');
}
});


// Function to get CSRF token from cookies
function getCSRFToken() {
const cookieValue = document.cookie
    .split('; ')
    .find(row => row.startsWith('csrftoken='))
    ?.split('=')[1];
return cookieValue;
}


// /////////////////////////////////////////////////////////////////////////////////////////////////

// this is for the parameter factor script




     // Function to send the selected part_model value to the backend
function sendPartModelValue() {
    const selectElement = document.getElementById('part_model');
    const selectedValue = selectElement.value;

    console.log("selectedValue",selectedValue)

    // Sending a POST request to the backend
    fetch('/comport/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') // Add CSRF token
        },
        body: JSON.stringify({ part_model: selectedValue })
    })
        .then(response => response.json())
        .then(data => {
            //console.log('Response from server:', data);

            // Now update the parameter_name dropdown
            const parameterNameDropdown = document.getElementById('parameter_name');
            
            // Clear the current options
            parameterNameDropdown.innerHTML = '';

            // Add the default "Select the parameter name" option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select the parameter name';
            parameterNameDropdown.appendChild(defaultOption);

            // Check if there are parameter names returned
            if (data.parameter_names && data.parameter_names.length > 0) {
                // Add an initial "Select" option
               

                // Populate the dropdown with parameter names
                data.parameter_names.forEach(param => {
                    const option = document.createElement('option');
                    option.value = param;
                    option.textContent = param;
                    parameterNameDropdown.appendChild(option);
                });
            } else {
                // If no parameter names, display a message
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No parameters available';
                parameterNameDropdown.appendChild(option);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}



// Function to send all form data to the backend when the form is submitted
function handleSaveButtonClick(event) {
    event.preventDefault();  // Prevent the default form submission behavior

    const partModel = document.getElementById('part_model').value;
    const parameterName = document.getElementById('parameter_name').value;
    const method = document.getElementById('method').value;
    const value = document.getElementById('value').value;

    // Prepare the data to send in the request
    const data = {
        request_type :"parameter_factor",
        part_model: partModel,
        parameter_name: parameterName,
        method: method,
        value: value
    };

    console.log("the data whic is send from the frntbend",data)

    // Send a POST request to save the data
    fetch('/comport/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')  // Add CSRF token
        },
        body: JSON.stringify(data)
    })
        .then(response => response.json())
        .then(data => {
            console.log('Data saved successfully:', data);
            showNotifications('Data saved successfully!');
        })
        .catch(error => {
            //console.error('Error:', error);
            showNotifications('An error occurred while saving data.');
        });
}

// Attach event listener to the save button
document.getElementById('save-btn-5').addEventListener('click', handleSaveButtonClick);

document.getElementById('part_model').addEventListener('change', function() {
    const partModel = this.value;
    
    if (partModel) {
        fetch(`/get_parameters/?part_model=${partModel}`)
            .then(response => response.json())
            .then(data => {
                const parameterDropdown = document.getElementById('parameter_name');
                parameterDropdown.innerHTML = '<option value="" disabled selected>Select a parameter</option>';

                data.parameter_names.forEach(param => {
                    const option = document.createElement('option');
                    option.value = param;
                    option.textContent = param;
                    parameterDropdown.appendChild(option);
                });

                document.getElementById('value').value = ''; // Clear the value field
            })
            .catch(error => console.error('Error fetching parameters:', error));
    }
});

document.getElementById('parameter_name').addEventListener('change', function() {
    const partModel = document.getElementById('part_model').value;
    const parameterName = this.value;

    if (partModel && parameterName) {
        fetch(`/get_parameter_value/?part_model=${partModel}&parameter_name=${parameterName}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('value').value = data.value || ''; // Set the retrieved value
                document.getElementById('method').value = data.method || ''; // Set the retrieved method
            })
            .catch(error => console.error('Error fetching value:', error));
    }
});


        // Helper function to get the CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    
        // Send the value when the page is loaded
        window.onload = () => {
            sendPartModelValue();
        };
</script>

   
         
        
        <div class="sub-container-3 sub-container">
            <div class="left_container">
                <button id="cnc_settings" class="toggle-btn">CNC SETTINGS</button>
                <button id="offset" class="toggle-btn">OFFSET</button>
                <button id="cnc_ip" class="toggle-btn">CNC MACHINE IP</button>
            </div>
            <div class="right_container">
               
                <div id="table5" class="table hidden" style="height: 100%;width: 100%;">
                    <center style="color: purple; text-shadow: 2px 2px 4px rgb(240, 118, 240);">
                        <h1><b>CNC SETTINGS</b></h1>
                    </center>
                    
                        <div class="form-container">
                            <div class="form-row">
                                <label for="cnc_machine_ip" class="form-label">CNC MACHINE IP</label>
                                <span class="colon">:</span>
                                <input type="text" id="cnc_machine_ip" name="cnc_machine_ip"  class="form-input">
                            </div>
                            <div class="form-row">
                                <label for="cnc_machine_port" class="form-label">CNC MACHINE PORT</label>
                                <span class="colon">:</span>
                                <input type="text" id="cnc_machine_port" name="cnc_machine_port" step="1" class="form-input">
                            </div>
                        </div>
                        
                        <textarea  id="shift_output">
                            
                        </textarea>
                    <div class="button_container2">
                    
                    <button type="button" id="cancel-btn"><b>CANCEL</b></button>
                    <button type="button" id="edit-btn"><b>EDIT</b></button>
                    <button type="button" id="ping_btn"><b>PING</b></button> 
                     
                    </div>
                
                
                </div>
                <div id="table6" class="table hidden" style="width: 100%;">
                    <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                        <thead style="background-color: gray;">
                            <tr class="custom-row">
                                <th style="width: 5%;">SR NO</th>
                                <th style="width: 30%;">SPEC</th>
                                <th style="width: 15%;">CHANNEL 1</th>
                                <th style="width: 15%;">CHANNEL 2</th>
                                <th style="width: 15%;">CHANNEL 3</th>
                                <th style="width: 15%;">CHANNEL 4</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody-2">

                        </tbody>
                    </table>
                    <div class="button_container2">
                    
                        <button type="button" id="cancel-btn"><b>CANCEL</b></button>
                        <button type="button" id="edit-btn"><b>EDIT</b></button>
                        <button type="button" id="save-btn-2"><b>SAVE</b></button>  
                    </div>
                </div>
                

                <div id="table7" class="table hidden" style="width: 100%;">
                    <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                        <thead style="background-color: gray;">
                            <tr class="custom-row">
                                <th style="width: 5%;">SR NO</th>
                                <th style="width: 30%;">CNC MACHINE IP</th>
                                <th style="width: 15%;">CHANNEL 1</th>
                                <th style="width: 15%;">CHANNEL 2</th>
                                <th style="width: 15%;">CHANNEL 3</th>
                                <th style="width: 15%;">CHANNEL 4</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody-3">

                        </tbody>
                    </table>
                    <div class="button_container2">
                    
                        <button type="button" id="cancel-btn"><b>CANCEL</b></button>
                        <button type="button" id="edit-btn"><b>EDIT</b></button>
                        <button type="button" id="save-btn-2"><b>SAVE</b></button>  
                    </div>
                </div>
            </div>
            
               
           
        </div>
    </div>
    
</div>

<script>

document.addEventListener("DOMContentLoaded", function () {
    const inputs = document.querySelectorAll("input");
    inputs.forEach(input => input.setAttribute("autocomplete", "off"));
});

document.addEventListener("keydown", function (event) {
    // Check if F4 is pressed
    if (event.key === "F12") {
        event.preventDefault(); // Prevent default F4 behavior (optional)
        
        // Redirect to the Measurement page
        window.location.href = "/measurement";  // Replace with your actual path
    }
});
    




/////////////////////////////////////////////////////////////////////
const ws = new WebSocket('ws://localhost:8000/ws/comport/'); // WebSocket connection
    
    // Wait for the connection to open
    ws.onopen = () => {
        console.log('WebSocket connection established');
    };

    // Handle incoming messages from the WebSocket server
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const message = data.message;

        // Display the received serial data in the output textarea
        const outputResult = document.getElementById('output_result');
        outputResult.value += message + "\n"; // Append new message to the textarea
        outputResult.scrollTop = outputResult.scrollHeight; // Scroll to the bottom
    };

    setInterval(function() {
    const outputResult = document.getElementById('output_result');
    outputResult.value = '';  // Clear the textarea
}, 2000);

    // Handle WebSocket errors
    ws.onerror = function(error) {
        console.log('WebSocket error:', error);
    };

    // Handle WebSocket close event
    ws.onclose = function(event) {
        console.log('WebSocket closed:', event);
    };

    // Handle the click event on the "OK" button
    document.getElementById('start-button').addEventListener('click', function() {
        const comPort = document.getElementById('comport').value;
        const baudRate = document.getElementById('baud_rate').value;
        const parity = document.getElementById('parity').value;
        const stopBit = document.getElementById('stop_bit').value;
        const dataBit = document.getElementById('data_bit').value;

        // Send the selected serial parameters to the WebSocket server
        const message = {
            command: 'start_serial',
            com_port: comPort,
            baud_rate: baudRate,
            parity: parity,
            stopbit: stopBit,
            databit: dataBit
        };

        ws.send(JSON.stringify(message)); // Send data to WebSocket server
    });





////////////////////////////////////////////////////////////////////////
 // CSRF token setup
 function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // AJAX POST request
    document.getElementById("start-button").addEventListener("click", function (event) {
    event.preventDefault();

    const data = {
        request_type: "comport", // Add a request type to identify this request
        com_port: document.getElementById("comport").value,
        baud_rate: document.getElementById("baud_rate").value,
        parity: document.getElementById("parity").value,
        stop_bit: document.getElementById("stop_bit").value,
        data_bit: document.getElementById("data_bit").value
    };

    fetch('/comport/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken // Include CSRF token in headers
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        console.log(result);
        showNotifications(result.message);
    })
    .catch(error => console.error('Error:', error));
});
    
////////////////////////////////////////////////////////////////////////


   function showSubContainer(index) {
    // Hide all sub-containers
    const subContainers = document.querySelectorAll('.sub-container');
    subContainers.forEach(container => container.classList.remove('active'));

    // Show the selected sub-container
    const selectedContainer = document.querySelector(`.sub-container-${index}`);
    if (selectedContainer) {
        selectedContainer.classList.add('active');
    }
}

// Ensure .sub-container-1 is active initially
document.addEventListener('DOMContentLoaded', () => {
    const initialContainer = document.querySelector('.sub-container-1');
    if (initialContainer) {
        initialContainer.classList.add('active');
    }
});



document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.toggle-btn');
    const containers = document.querySelectorAll('.table');

    // Ensure table1 and table4 are visible initially
    const initialTables = ['table1', 'table5'];
    initialTables.forEach(tableId => {
        const table = document.getElementById(tableId);
        if (table) {
            table.classList.remove('hidden');
        }
    });

    buttons.forEach((button, index) => {
        button.addEventListener('click', () => {
            // Hide all containers
            containers.forEach(container => container.classList.add('hidden'));
            // Show the corresponding container
            const target = document.getElementById(`table${index + 1}`);
            if (target) {
                target.classList.remove('hidden');
            }
        });
    });
});


 // JavaScript to add 5 rows with SPEC names
    const tableBody = document.getElementById('tableBody-2');

    // List of SPEC names
    const specNames = [
    "TOOL NO",
"TOOL AXIS",
"UPPER WEAR OFFSET LIMIT ",
"LOWER WEAR OFFSET LIMIT ",
"NEW OFFSET ",
"OFFSET OFFSET" ,
    ];

    // Loop through the spec names and create rows
    specNames.forEach((spec, index) => {
        const row = document.createElement('tr');
        row.className = 'custom-row';

        // Create the cells for each row
        row.innerHTML = `
            <td style="border: 1px solid black;">${index + 1}</td>
            <td style="border: 1px solid black;">${spec}</td>
            <td><input type="text" class="no-outline" style="width: 100%;"></td>
            <td><input type="text" class="no-outline" style="width: 100%;"></td>
            <td><input type="text" class="no-outline" style="width: 100%;"></td>
            <td><input type="text" class="no-outline" style="width: 100%;"></td>
        `;

        // Append the row to the table body
        tableBody.appendChild(row);
    });


    // JavaScript to add 5 rows with SPEC names
    const tableBody3 = document.getElementById('tableBody-3');

    // List of SPEC names
    const CNC_IP = [
    "CNC MACHINE PORT",
"CNC TIME OUT",
"TOOL AXIS ",
"TOOL NO ",
"OFFSET ",
"PART COUNT" ,
"CNC LEAST COUNT"
    ];

    // Loop through the spec names and create rows
    CNC_IP.forEach((spec, index) => {
        const row = document.createElement('tr');
        row.className = 'custom-row';

        // Create the cells for each row
        row.innerHTML = `
            <td style="border: 1px solid black;">${index + 1}</td>
            <td style="border: 1px solid black;">${spec}</td>
            <td><input type="text" class="no-outline" style="width: 100%;"></td>
            <td><input type="text" class="no-outline" style="width: 100%;"></td>
            <td><input type="text" class="no-outline" style="width: 100%;"></td>
            <td><input type="text" class="no-outline" style="width: 100%;"></td>
        `;

        // Append the row to the table body
        tableBody3.appendChild(row);
    });

///////////////////////////////////////////////////////////////////////////////////////////

function addRow() {
    const tableBody = document.getElementById("tableBody-1");

    // Get the current number of rows
    const rowCount = tableBody.getElementsByTagName("tr").length;

    // Create a new row
    const newRow = document.createElement("tr");
    newRow.classList.add("custom-row");

    // Create and append cells to the new row
    newRow.innerHTML = `
        <td>${rowCount + 1}</td>
        <td><input type="text" class="no-outline" style="width: 100%;"></td>
        <td><input type="text" class="no-outline" style="width: 100%;"></td>
    `;

    // Append the new row to the table body
    tableBody.appendChild(newRow);
}

// Save operator data via AJAX
function saveData() {
    const rows = document.querySelectorAll("#tableBody-1 tr");
    const data = Array.from(rows).map(row => {
        const inputs = row.querySelectorAll("input");
        return {
            request_type: "operator",
            operator_no: inputs[0].value,
            operator_name: inputs[1].value
        };
    });

    console.log("Data being sent to the backend:", data);

    $.ajax({
        url: "/comport/",
        type: "POST",
        headers: {
            "X-CSRFToken": getCSRFToken()
        },
        contentType: "application/json",
        data: JSON.stringify(data),
        success: function (response) {
            if (response.status === "success") {
                console.log("Data saved successfully:", response);
                showNotifications("Data saved successfully!");
                localStorage.setItem("activeTab", "settings_btn"); // â† save tab
                setTimeout(() => window.location.reload(), 500);   // delay to let user see notification
            } else {
                showNotifications("Error: " + response.message);
            }
        },
        error: function (xhr) {
            showNotifications("An error occurred while saving the data.");
        }
    });
}



    function getCSRFToken() {
        const cookies = document.cookie.split("; ");
        for (let cookie of cookies) {
            const [name, value] = cookie.split("=");
            if (name === "csrftoken") return value;
        }
        return "";
    }


//////////////////////////////////////////////////////////

// delete the seleected rows:

// Function to handle row selection
function selectRow(row) {
    // Remove highlight from all rows
    const rows = document.querySelectorAll("#tableBody-1 tr");
    rows.forEach(r => r.style.backgroundColor = "");

    // Highlight the selected row
    row.style.backgroundColor = "yellow";

    // Get the operator_no and operator_name from the input fields in the selected row
    const operatorNo = row.querySelector('td:nth-child(2) input').value;
    const operatorName = row.querySelector('td:nth-child(3) input').value;

    // Console log the operator info
    console.log(`Selected Operator No: ${operatorNo}`);
    console.log(`Selected Operator Name: ${operatorName}`);

    // Store the selected operator data in the row's data attributes
    row.setAttribute("data-operator-no", operatorNo);
    row.setAttribute("data-operator-name", operatorName);
}

// Function to delete the selected row
function deleteRow() {
    const selectedRow = document.querySelector("#tableBody-1 tr[style*='background-color: yellow']");
    
    if (selectedRow) {
        const operatorNo = selectedRow.getAttribute("data-operator-no"); // Get the operator_no from data attributes
        const operatorName = selectedRow.getAttribute("data-operator-name"); // Get the operator_name from data attributes
        const request = 'delete'
        if (operatorNo && operatorName) {
            // Send a POST request to delete the operator
            fetch("/comport/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"), // Ensure you have CSRF protection enabled
                },
                body: JSON.stringify({request_type:request, operator_no: operatorNo, operator_name: operatorName }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    // Remove the row from the table
                    selectedRow.remove();
                    showNotifications("Row deleted successfully!");
                } else {
                    showNotifications(data.message);
                }
            })
            .catch(error => {
                showNotifications("Error deleting row: " + error);
            });
        } else {
            showNotifications("Operator No or Name not found.");
        }
    } else {
        showNotifications("Please select a row to delete.");
    }
}

// Function to get the CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add event listeners to existing rows for selection functionality
const existingRows = document.querySelectorAll("#tableBody-1 tr");
existingRows.forEach(row => {
    row.addEventListener("click", function () {
        selectRow(row);
    });
});






let isNotificationOpen = false;

function showNotifications(message) {
    isNotificationOpen = true;
    document.getElementById("notificationMessage").textContent = message;
    document.getElementById("notificationModal").style.display = "flex";
    document.getElementById("notificationOkBtn").focus();

    document.getElementById("notificationOkBtn").onclick = () => {
        document.getElementById("notificationModal").style.display = "none";
        isNotificationOpen = false;

       
    };
}
















const alpha_map = {
    "1": "1.,",
    "2": "abc", "3": "def", "4": "ghi", "5": "jkl",
    "6": "mno", "7": "pqrs", "8": "tuv", "9": "wxyz",
    "0": "0+-*#"
};

function backspaceInput() {
    if (!inTable) return;  // Only backspace inside the table inputs

    const rows = document.querySelectorAll("#tableBody-1 tr");
    const row = rows[tableRowIndex];
    if (!row) return;

    const inputs = row.querySelectorAll("input");
    const el = inputs[tableColIndex];
    if (el && el.tagName === "INPUT") {
        el.value = el.value.slice(0, -1);
    }
}



////////////////////////////////////////////////////////////////////////////////////////////////

// THIS IS FOR THE OPERATOR SETTINGS

let tableRowIndex = 0;
let tableColIndex = 0;
let inTable = true;  // Are we inside the table or in the buttons?

const totalCols = 2;
function focusTableCell(rowIdx, colIdx) {
    const rows = document.querySelectorAll("#tableBody-1 tr");
    if (rows.length === 0) {
        focusActionButton(0);
        inTable = false;
        return;
    }

    // Clear previous focus styles
    rows.forEach(row => {
        row.querySelectorAll("input").forEach(input => {
            input.classList.remove("focused");
        });
    });

    const row = rows[rowIdx];
    if (!row) return;

    const inputs = row.querySelectorAll("input");
    if (inputs[colIdx]) {
        inputs[colIdx].focus();
        inputs[colIdx].classList.add("focused");
    }
}


const actionButtons = [
    document.getElementById("add_new_btn"),
    document.getElementById("save_btn_cus"),
    document.getElementById("delete_btn")
];

let buttonIndex = 0;

function focusActionButton(idx) {
    buttonIndex = idx;
    inTable = false;
    actionButtons.forEach((btn, i) => {
        if (i === idx) {
            btn.focus();
            btn.classList.add("focused");
        } else {
            btn.classList.remove("focused");
        }
    });
}
function handleOperatorNavigation(key) {
    const rows = document.querySelectorAll("#tableBody-1 tr");
    const totalRows = rows.length;

    if (key === "RGT") {
        if (inTable) {
            if (tableColIndex < totalCols - 1) {
                tableColIndex++;
            } else {
                if (tableRowIndex < totalRows - 1) {
                    tableRowIndex++;
                    tableColIndex = 0;
                } else {
                    // Exit table â†’ Enter buttons
                    inTable = false;
                    focusActionButton(0);
                    return;
                }
            }
            focusTableCell(tableRowIndex, tableColIndex);
        } else {
            // In buttons
            buttonIndex = (buttonIndex + 1) % actionButtons.length;
            focusActionButton(buttonIndex);
        }
    }

    if (key === "LFT") {
        if (inTable) {
            if (tableColIndex > 0) {
                tableColIndex--;
            } else if (tableRowIndex > 0) {
                tableRowIndex--;
                tableColIndex = totalCols - 1;
            }
            focusTableCell(tableRowIndex, tableColIndex);
        } else {
            // In buttons
            if (buttonIndex > 0) {
                buttonIndex--;
                focusActionButton(buttonIndex);
            } else {
                // Move back to table
                const lastRow = totalRows - 1;
                inTable = true;
                tableRowIndex = lastRow;
                tableColIndex = totalCols - 1;
                focusTableCell(tableRowIndex, tableColIndex);
            }
        }
    }

    if (key === "ENT") {
    if (inTable) {
        const rows = document.querySelectorAll("#tableBody-1 tr");
        const currentRow = rows[tableRowIndex];
        if (currentRow) {
            selectRow(currentRow); // ðŸ‘ˆ Call your selection function here
        }
    } else {
        actionButtons[buttonIndex].click();
    }
}

}







let mode = ""; // "ALPHA" or "NUM"
let capsLock = true;
let lastTabPressTime = 0;
const doubleTapThreshold = 500; // milliseconds
let lastKey = null;
let lastPressTime = 0;
let cycleIndex = 0;
const cycleTimeout = 1000; // for character cycling


function handleT9Input(key) {
    
    
    const el = document.activeElement;
    if (!el || el.tagName !== "INPUT") return;

    const now = Date.now();

   

    // âœ… TOGGLE MODE
    if (key === "ALP/NUM") {
        mode = mode === "NUM" ? "ALPHA" : "NUM";
        lastKey = null;
        cycleIndex = 0;
        console.log(`[MODE] Switched to ${mode}`);
             // ðŸ” Sync LED status with mode
    if (mode === "ALPHA") {
        turnOnLED();
    } else if (mode === "NUM") {
        turnOffLED();
    }
        return;
    }




    // âœ… ALPHA MODE TYPING
    if (mode === "ALPHA" && alpha_map[key]) {
        if (key === lastKey && (now - lastPressTime) < cycleTimeout) {
            cycleIndex = (cycleIndex + 1) % alpha_map[key].length;
            let charToReplace = alpha_map[key][cycleIndex];
            if (capsLock) charToReplace = charToReplace.toUpperCase();
            el.value = el.value.slice(0, -1) + charToReplace;
        } else {
            cycleIndex = 0;
            let charToAdd = alpha_map[key][cycleIndex];
            if (capsLock) charToAdd = charToAdd.toUpperCase();
            el.value += charToAdd;
        }
        lastKey = key;
        lastPressTime = now;
    }

    // âœ… NUM MODE TYPING (just numbers)
    else if (mode === "NUM" && key >= "0" && key <= "9") {
        el.value += key;
        lastKey = null;
        cycleIndex = 0;
    }
}
///////////////////////////////////////////////////////////////////////////////////////
// SHIFT SETTING KEYPAD CODE 

document.getElementById("shift_settings").addEventListener("click", () => {
    const table2 = document.getElementById("table2");
    if (table2) {
        table2.classList.remove("hidden");

        const table1 = document.getElementById("table1");
        if (table1) table1.classList.add("hidden");

        // Reset focus index
        shiftFocusIndex = 0;

        setTimeout(() => {
            const shiftInput = document.getElementById("shift");

            if (shiftInput) {
                shiftInput.focus();

                // Set caret position after 'SHIFT-'
                const cursorPos = shiftInput.value.length;
                shiftInput.setSelectionRange(cursorPos, cursorPos);

                // Optional: highlight it as focused
                document.querySelectorAll(".focusable").forEach(el => el.classList.remove("focused"));
                shiftInput.classList.add("focused");

                console.log("[FOCUS] #shift input is now focused with cursor at end");
            }
        
        }, 100);
    }

});


let shiftFocusIndex = 0;

function handleShiftSettingsNavigation(key) {
   
    const shiftTable = document.getElementById("table2");
    if (!shiftTable || shiftTable.classList.contains("hidden")) return;

    const focusables = Array.from(shiftTable.querySelectorAll(".focusable"));

    if (focusables.length === 0) return;

    // Remove previous highlight
    focusables.forEach(el => el.classList.remove("focused"));

    if (key === "RGT") {
        shiftFocusIndex = (shiftFocusIndex + 1) % focusables.length;
    } else if (key === "LFT") {
        shiftFocusIndex = (shiftFocusIndex - 1 + focusables.length) % focusables.length;
    } else {
        return; // Ignore unrelated keys
    }

    // Apply focus and highlight
    const newEl = focusables[shiftFocusIndex];
    newEl.focus();
    newEl.classList.add("focused");

    console.log(`[NAV] Focus moved to: #${newEl.id}`);
}


function handleShiftSettingsInput(key) {
    const activeElement = document.activeElement;

    if (activeElement && activeElement.tagName === 'INPUT' && activeElement.classList.contains("focusable")) {
        if (activeElement.id === "shift") {
            if (!activeElement.value.startsWith("SHIFT-")) {
                activeElement.value = "SHIFT-";
            }
            activeElement.value = "SHIFT-" + key;
        } else if (["hh", "min"].includes(activeElement.id)) {
            const maxLength = parseInt(activeElement.getAttribute("maxlength") || "2");
            if (activeElement.valu/comport/e.length < maxLength) {
                activeElement.value += key;
            }
        }

        activeElement.setSelectionRange(activeElement.value.length, activeElement.value.length);

        // Ensure the focused class is present and focus is maintained
        activeElement.classList.add("focused");
        activeElement.focus();

        console.log(`[INPUT] '${key}' inserted into #${activeElement.id}`);
    }
}

//----------------------------------------BACKUP SETTINGS--------------------------------------------//



document.getElementById("open_backup").addEventListener("click", () => {

    const table3 = document.getElementById("table3");
    if (table3) {
        table3.classList.remove("hidden");

        const table1 = document.getElementById("table1");
        if (table1) table1.classList.add("hidden");

        const table2 = document.getElementById("table2");
        if (table2) table2.classList.add("hidden");

        // Reset focus index or selection logic if needed

        setTimeout(() => {
            const ddInput = document.getElementById("dd");

            if (ddInput) {
                ddInput.focus();

                // Optional: move cursor to end
                const cursorPos = ddInput.value.length;
                ddInput.setSelectionRange(cursorPos, cursorPos);

                // Highlight the input as focused
                document.querySelectorAll(".focusable").forEach(el => el.classList.remove("focused"));
                ddInput.classList.add("focused");

                console.log("[FOCUS] #dd input is now focused with cursor at end");
            }
        }, 100);
    }
});



let backupFocusIndex = 0;

function handleBackupSettingsNavigation(key) {
    const backupTable = document.getElementById("table3");
    if (!backupTable || backupTable.classList.contains("hidden")) return;

    const focusables = Array.from(backupTable.querySelectorAll(".focusable"));

    if (focusables.length === 0) return;

    // Remove existing focus style
    focusables.forEach(el => el.classList.remove("focused"));

    // Update index based on key
    if (key === "RGT") {
        backupFocusIndex = (backupFocusIndex + 1) % focusables.length;
    } else if (key === "LFT") {
        backupFocusIndex = (backupFocusIndex - 1 + focusables.length) % focusables.length;
    } else {
        return; // Ignore other keys
    }

    // Apply focus and highlight
    const newEl = focusables[backupFocusIndex];
    newEl.focus();
    newEl.classList.add("focused");

    // Move caret to end if input
    if (newEl.tagName === "INPUT" && typeof newEl.setSelectionRange === "function") {
        const len = newEl.value.length;
        newEl.setSelectionRange(len, len);
    }

    console.log(`[NAV] Backup focus moved to: #${newEl.id}`);
}


//----------------------------------------------PARAMETER FACTOR ---------------------------------------------//




document.getElementById("parameter_factor").addEventListener("click", () => {
  
    const table4 = document.getElementById("table4");
    if (table4) {
        table4.classList.remove("hidden");

        // Hide other tables
        const tables = ["table1", "table2", "table3"];
        tables.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add("hidden");
        });

        // Set focus to "part_model" after short delay
        setTimeout(() => {
            const partModel = document.getElementById("part_model");

            if (partModel) {
                partModel.focus();

                // Highlight the select as focused
                document.querySelectorAll(".focusable").forEach(el => el.classList.remove("focused"));
                partModel.classList.add("focused");

                console.log("[FOCUS] #part_model select is now focused");
            }
        }, 100);
    }
});

let parameterFocusIndex = 0;

function handleParameterFactorNavigation(key) {
    const table4 = document.getElementById("table4");
    if (!table4 || table4.classList.contains("hidden")) return;

    // Elements to focus/navigate
    const focusables = Array.from(table4.querySelectorAll("#part_model, #parameter_name, #method, #value, #cancel-btn, #save-btn-5"));

    if (focusables.length === 0) return;

    const currentEl = focusables[parameterFocusIndex];

    // Handle up/down for select elements only
    if (key === "UP" || key === "DWN") {
        if (currentEl.tagName === "SELECT") {
            const maxIndex = currentEl.options.length - 1;
            let newIndex = currentEl.selectedIndex;

            if (key === "UP") {
                newIndex = (newIndex - 1 + currentEl.options.length) % currentEl.options.length;
            } else if (key === "DWN") {
                newIndex = (newIndex + 1) % currentEl.options.length;
            }

            currentEl.selectedIndex = newIndex;
            currentEl.focus();

            console.log(`[SELECT] ${key} pressed, new selectedIndex: ${newIndex} for #${currentEl.id}`);

            // Optionally trigger change event if you rely on it
            currentEl.dispatchEvent(new Event('change'));

            return; // Stop here, don't move focus
        }
    }

    // Remove existing focus style for navigation keys LFT and RGT
    if (key === "LFT" || key === "RGT") {
        focusables.forEach(el => el.classList.remove("focused"));

        if (key === "RGT") {
            parameterFocusIndex = (parameterFocusIndex + 1) % focusables.length;
        } else if (key === "LFT") {
            parameterFocusIndex = (parameterFocusIndex - 1 + focusables.length) % focusables.length;
        }

        const newEl = focusables[parameterFocusIndex];
        newEl.focus();
        newEl.classList.add("focused");

        // Move caret to end if input
        if (newEl.tagName === "INPUT" && typeof newEl.setSelectionRange === "function") {
            const len = newEl.value.length;
            newEl.setSelectionRange(len, len);
        }

        console.log(`[NAV] Parameter Factor focus moved to: #${newEl.id}`);
    }

    const valueInput = document.getElementById("value");
    if (!valueInput) return;



    // Check if #value is focused
    if (document.activeElement === valueInput) {
        if (mode === "NUM") {
        if (/^[0-9]$/.test(key)) {
            // Prevent default behavior if you want to fully control input
            // (optional, depending on your event context)
            
            if (key === lastValueKey) {
                // Same key pressed twice â†’ add '.'
                valueInput.value += '.';
                lastValueKey = null; // reset
            } else {
                valueInput.value += key;
                lastValueKey = key;
            }

            // Move caret to end
            const len = valueInput.value.length;
            valueInput.setSelectionRange(len, len);
            valueInput.focus();

            console.log(`[PARAMETER FACTOR] Added '${valueInput.value.slice(-1)}'`);
        } }else {
            lastValueKey = null; // reset if other key pressed
             // â— Show warning when in ALPHA mode but user tries to enter numbers
             if (/^[0-9]$/.test(key)) {
                showNotifications("Please change mode to NUM to enter numbers.");
                return;
            }
        }
    }
     // New: If focused element is button and ENT pressed â†’ click it
     if (key === "ENT" && currentEl.tagName === "BUTTON") {
        currentEl.click();
    }

    if (key === "F9") {
    const table4 = document.getElementById("table4");
    if (table4) {
        table4.classList.toggle("hidden");
        console.log(`[TOGGLE] Table2 visibility toggled. Now hidden: ${table4.classList.contains("hidden")}`);
    }
    return;
}
}



//------------------------------------- GENERAl BUTTONS -------------------------------------- //



const settingsButtons = [
    document.getElementById("operators"),
    document.getElementById("shift_settings"),
    document.getElementById("open_backup"),
    document.getElementById("parameter_factor")
];

let settingsActiveIndex = 0;

function updateSettingsFocus() {
    settingsButtons.forEach((btn, idx) => {
        if (idx === settingsActiveIndex) {
            btn.classList.add("focused");
            btn.focus();
        } else {
            btn.classList.remove("focused");
        }
    });
    
}

settingsButtons.forEach((btn, idx) => {
    btn.addEventListener("click", () => {
        settingsActiveIndex = idx;
        updateSettingsFocus();
    });
});


function handleSettingsNavigation(key) {
    switch (key) {
        case "UP":
            settingsActiveIndex = (settingsActiveIndex - 1 + settingsButtons.length) % settingsButtons.length;
            updateSettingsFocus();
            break;
        case "DWN":
            settingsActiveIndex = (settingsActiveIndex + 1) % settingsButtons.length;
            updateSettingsFocus();
            break;
        case "ENT":
            settingsButtons[settingsActiveIndex].click();
            break;
    }
}







function activateButton(buttonId) {
    // Remove .active from all buttons
    document.querySelectorAll(".container-1-2 button").forEach(btn => {
        btn.classList.remove("active");
    });

    // Add .active to the clicked one
    const btn = document.getElementById(buttonId);
    if (btn) {
        btn.classList.add("active");
        btn.click(); // Trigger the associated action
    }
}


//------------------------------------- WEB SOCKET KEYPAD LINK -------------------------------------- //

// WebSocket handling
const keyboardSocket = new WebSocket("ws://" + window.location.host + "/ws/keypad/");


keyboardSocket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    const key = data.key;
    console.log("[WebSocket] Key received:", key);

    if (isNotificationOpen) {
    if (key === "ENT") {
        document.getElementById("notificationOkBtn").click();
    }
    return; // block all other key actions while notification is shown
}

    const keyMap = {
        "F1": "comport_btn",
        "F2": "settings_btn",
        "F3": "cmc_btn",
        "F6": "parameter-settings"
    };

    if (key in keyMap) {
        activateButton(keyMap[key]);
        if (key === "F2") {
            settingsActiveIndex = 0;
            updateSettingsFocus();
            turnOffLED();

            if (mode === "") {
            showNotifications("Mode is not set. Please switch to NUM mode.");

            // ðŸ” Re-focus after a slight delay to allow notification dismissal
            setTimeout(() => {
                const table = document.getElementById("table1");
                table.classList.remove("hidden");

                inTable = true;
                tableRowIndex = 0;
                tableColIndex = 0;

                focusTableCell(tableRowIndex, tableColIndex);
            }, 1000);  // slightly longer delay to let alert finish

            return;
        }

            setTimeout(() => {
                const table = document.getElementById("table1");
                table.classList.remove("hidden");

                inTable = true;
                tableRowIndex = 0;
                tableColIndex = 0;

                focusTableCell(tableRowIndex, tableColIndex);
            }, 100);
        }
        return;
    }

    // Handle main setting form navigation
    if (document.querySelector('.sub-container-1').style.display !== "none") {
        handleFormNavigation(key);
    }

    if (key === "F12") {
            document.getElementById("close_btn").click();
        } 

    // // Handle secondary settings navigation
    // if (document.querySelector('.sub-container-2').style.display !== "none") {
    //     handleSettingsNavigation(key);
    // }

// Handle secondary settings navigation ONLY if table2 is hidden
if (document.querySelector('.sub-container-2').style.display !== "none" &&
    (document.getElementById("table2")?.classList.contains("hidden") ?? true) && 
    (document.getElementById("table3")?.classList.contains("hidden") ?? true) &&
    (document.getElementById("table4")?.classList.contains("hidden") ?? true)) {
    handleSettingsNavigation(key);
}









    // Handle table1 input and navigation
    if (document.getElementById("table1") && !document.getElementById("table1").classList.contains("hidden")) {
        handleOperatorNavigation(key);

        
        

        if (/^[0-9]$/.test(key) || key === "ALP/NUM") {
            if (inTable) {
                 // ðŸ”´ Alert if mode is null
            
                handleT9Input(key);
                return;
            }
        }

        if (key === "F10") {
            backspaceInput();
            return;
        }
    }

    // Handle shift settings (table2)
    if (document.getElementById("table2") && !document.getElementById("table2").classList.contains("hidden")) {
    // Navigation first (LFT, RGT, UP, DWN)
    handleShiftSettingsNavigation(key);

    if (key === "ALP/NUM") {
        mode = mode === "NUM" ? "ALPHA" : "NUM";
        lastKey = null;
        cycleIndex = 0;
        console.log(`[MODE] Switched to ${mode}`);
                  // ðŸ” Sync LED status with mode
    if (mode === "ALPHA") {
        turnOnLED();
    } else if (mode === "NUM") {
        turnOffLED();
    }
   
        return;
    }
    

    const activeElement = document.activeElement;

    // Input digits only into inputs (#shift, #hh, #min)

    if (mode === "NUM") {
        if (/^[0-9]$/.test(key)) {
            handleShiftSettingsInput(key);
            return;
        }
        } else {
    // â— Show warning when in ALPHA mode but user tries to enter numbers
    if (/^[0-9]$/.test(key)) {
        showNotifications("Please change mode to NUM to enter numbers.");

        // ðŸ” Re-focus the #shift input after notification
        setTimeout(() => {
            const shiftInput = document.getElementById("shift");

            if (shiftInput) {
                shiftInput.focus();

                // Place cursor at end
                const cursorPos = shiftInput.value.length;
                shiftInput.setSelectionRange(cursorPos, cursorPos);

                // Optional: highlight focused style
                document.querySelectorAll(".focusable").forEach(el => el.classList.remove("focused"));
                shiftInput.classList.add("focused");

                console.log("[FOCUS RESTORED] #shift input is focused again");
            }
        }, 500); // Delay allows notification (e.g. modal/toast) to be dismissed

        return;
    }
}

   
    

    // Handle backspace in these inputs with F10
    if (key === "F10") {
        if (activeElement && activeElement.tagName === "INPUT" && activeElement.classList.contains("focusable")) {
            // Backspace logic for inputs in table2
            let val = activeElement.value;

            if (activeElement.id === "shift") {
                // For shift, keep the prefix "SHIFT-" intact
                if (val.length > 6) { // length of "SHIFT-"
                    activeElement.value = val.slice(0, -1);
                }
            } else if (["hh", "min"].includes(activeElement.id)) {
                // Normal backspace for hh/min
                activeElement.value = val.slice(0, -1);
            }

            // Maintain focus & selection at the end
            const len = activeElement.value.length;
            activeElement.setSelectionRange(len, len);
            activeElement.classList.add("focused");
            activeElement.focus();

            console.log(`[BACKSPACE] F10 pressed in #${activeElement.id}`);
        }
        return;
    }

    // Handle UP/DWN for AM/PM select in table2
if ((key === "UP" || key === "DWN") && document.getElementById("table2") && !document.getElementById("table2").classList.contains("hidden")) {
    const activeElement = document.activeElement;

    if (activeElement && activeElement.tagName === "SELECT" && activeElement.id === "ampm") {
        const options = Array.from(activeElement.options);
        const currentIndex = activeElement.selectedIndex;

        let newIndex;
        if (key === "UP") {
            newIndex = (currentIndex - 1 + options.length) % options.length;
        } else if (key === "DWN") {
            newIndex = (currentIndex + 1) % options.length;
        }

        activeElement.selectedIndex = newIndex;
        activeElement.classList.add("focused");
        activeElement.focus();

        console.log(`[AM/PM] ${key} changed selection to: ${activeElement.value}`);
        return;
    }
}

if (key === "F9") {
    const table2 = document.getElementById("table2");
    if (table2) {
        table2.classList.toggle("hidden");
        console.log(`[TOGGLE] Table2 visibility toggled. Now hidden: ${table2.classList.contains("hidden")}`);
    }
    return;
}



    

    // Handle Enter key press on focused button
    if (key === "ENT") {
        if (activeElement && activeElement.tagName === "BUTTON") {
            activeElement.click();
            console.log(`[CLICK] Button #${activeElement.id} clicked by ENT`);
        }
        return;
    }
}



// Handle backup settings (table3)
if (document.getElementById("table3") && !document.getElementById("table3").classList.contains("hidden")) {
    const activeElement = document.activeElement;
    if (key === "ALP/NUM") {
        mode = mode === "NUM" ? "ALPHA" : "NUM";
        lastKey = null;
        cycleIndex = 0;
        console.log(`[MODE] Switched to ${mode}`);
                  // ðŸ” Sync LED status with mode
    if (mode === "ALPHA") {
        turnOnLED();
    } else if (mode === "NUM") {
        turnOffLED();
    }
   
        return;
    }

    // Navigation
    handleBackupSettingsNavigation(key);


 
    if (mode === "NUM") {
    // Handle digit input
    if (/^[0-9]$/.test(key)) {
    if (activeElement && activeElement.tagName === "INPUT" && activeElement.id !== "ampm_back") {
        const id = activeElement.id;
        let currentValue = activeElement.value;

        const limits = {
            dd:  { maxLen: 2, maxVal: 31 },
            mm:  { maxLen: 2, maxVal: 12 },
            hour:{ maxLen: 2, maxVal: 12 },
            minute:{ maxLen: 2, maxVal: 59 },
            yyyy:{ maxLen: 4 }
        };

        if (!(id in limits)) return;

        const { maxLen, maxVal } = limits[id];

        if (currentValue.length < maxLen) {
            currentValue += key;

            // Check value range if maxVal is defined and enough digits entered
            if (maxVal !== undefined && currentValue.length === maxLen) {
                const numericValue = parseInt(currentValue, 10);
                if (numericValue > maxVal) {
                    console.warn(`[INVALID] ${id.toUpperCase()} value ${numericValue} exceeds max allowed ${maxVal}`);
                    return; // Reject input
                }
            }

            activeElement.value = currentValue;

            // Move caret to end
            const len = currentValue.length;
            activeElement.setSelectionRange(len, len);
            activeElement.focus();
            activeElement.classList.add("focused");

            console.log(`[INPUT] Inserted ${key} in #${id}`);
        } else {
            console.log(`[LIMIT] Max length reached for #${id}`);
        }
    }
    return;
}}
else {
            // â— Show warning when in ALPHA mode but user tries to enter numbers
            if (/^[0-9]$/.test(key)) {
                showNotifications("Please change mode to NUM to enter numbers.");
                return;
            }
    }



    // Handle backspace with F10
    if (key === "F10") {
        if (activeElement && activeElement.tagName === "INPUT") {
            activeElement.value = activeElement.value.slice(0, -1);

            // Maintain caret
            const len = activeElement.value.length;
            activeElement.setSelectionRange(len, len);
            activeElement.focus();
            activeElement.classList.add("focused");

            console.log(`[BACKSPACE] F10 pressed in #${activeElement.id}`);
        }
        return;
    }

    if (key === "F9") {
    const table3 = document.getElementById("table3");
    if (table3) {
        table3.classList.toggle("hidden");
        console.log(`[TOGGLE] Table2 visibility toggled. Now hidden: ${table3.classList.contains("hidden")}`);
    }
    return;
}


    // Handle UP/DWN for AM/PM
    if ((key === "UP" || key === "DWN") && activeElement.id === "ampm_back") {
        const select = activeElement;
        const options = Array.from(select.options);
        const currentIndex = select.selectedIndex;

        let newIndex = key === "UP"
            ? (currentIndex - 1 + options.length) % options.length
            : (currentIndex + 1) % options.length;

        select.selectedIndex = newIndex;
        select.focus();
        select.classList.add("focused");

        console.log(`[AMPM] ${key} toggled to ${select.value}`);
        return;
    }

     // Handle Enter key press on focused button
     if (key === "ENT") {
        if (activeElement && activeElement.tagName === "BUTTON") {
            activeElement.click();
            console.log(`[CLICK] Button #${activeElement.id} clicked by ENT`);
        }
        return;
    }

    
}


if (document.getElementById("table4") && !document.getElementById("table4").classList.contains("hidden")) {
    handleParameterFactorNavigation(key);
    if (key === "ALP/NUM") {
        mode = mode === "NUM" ? "ALPHA" : "NUM";
        lastKey = null;
        cycleIndex = 0;
        console.log(`[MODE] Switched to ${mode}`);
                  // ðŸ” Sync LED status with mode
    if (mode === "ALPHA") {
        turnOnLED();
    } else if (mode === "NUM") {
        turnOffLED();
    }
   
        return;
    }
}




};




// ------------- COMPORT SETTINGS FORM NAVIGATION LOGIC ------------- //

const focusOrder = [
    document.getElementById("comport"),
    document.getElementById("baud_rate"),
    document.getElementById("parity"),
    document.getElementById("stop_bit"),
    document.getElementById("data_bit"),
    document.getElementById("cancel_btn"),
    document.getElementById("start-button")
];

let activeIndex = 0;

function updateFocus() {
    const current = focusOrder[activeIndex];
    current.focus();
    focusOrder.forEach(el => el.classList.remove("focused"));
    current.classList.add("focused");
    
}

function handleFormNavigation(key) {
    switch (key) {
        case "UP":
            activeIndex = (activeIndex - 1 + focusOrder.length) % focusOrder.length;
            updateFocus();
            break;
        case "DWN":
            activeIndex = (activeIndex + 1) % focusOrder.length;
            updateFocus();
            break;
        case "LFT":
            adjustSelect(-1);
            break;
        case "RGT":
            adjustSelect(1);
            break;
        case "ENT":
            triggerButton();
            break;
    }
}

function adjustSelect(direction) {
    const el = focusOrder[activeIndex];
    if (el.tagName === "SELECT") {
        const max = el.options.length - 1;
        let newIndex = el.selectedIndex + direction;

        if (newIndex < 0) {
            newIndex = max; // Wrap to last
        } else if (newIndex > max) {
            newIndex = 0; // Wrap to first
        }

        el.selectedIndex = newIndex;
    }
}

function triggerButton() {
    const el = focusOrder[activeIndex];
    if (el.tagName === "BUTTON") {
        el.click();
    }
}

// Set default button and focus on load
window.onload = function() {
    activateButton('comport_btn');
    updateFocus();
};



const ledSocket = new WebSocket("ws://" + window.location.host + "/ws/led/");

function turnOnLED() {
    ledSocket.send(JSON.stringify({ command: "ON" }));
}

function turnOffLED() {
    ledSocket.send(JSON.stringify({ command: "OFF" }));
}



</script>
    
</body>
</html>